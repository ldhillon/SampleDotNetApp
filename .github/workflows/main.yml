name: .NET

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '8.0.x'

    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Create Docker network
      run: docker network create selenium-grid

    - name: Start Selenium Hub
      run: docker run -d --name selenium-hub --network selenium-grid -p 4444:4444 selenium/hub:4.21.0-20240522

    - name: Start Chrome Node
      run: docker run -d --name selenium-chrome --network selenium-grid -e SE_EVENT_BUS_HOST=selenium-hub selenium/node-chrome:4.21.0-20240522

    - name: Wait for Selenium Grid to be ready
      run: |
        for i in {1..60}; do
          if curl -s http://localhost:4444/wd/hub/status | grep -q '"ready": true'; then
            echo "Selenium Grid is ready"
            break
          fi
          echo "Waiting for Selenium Grid to be ready..."
          sleep 5
        done
        curl -s http://localhost:4444/wd/hub/status

    - name: Check Docker container status
      run: docker ps -a

    - name: Check Selenium Hub logs
      run: docker logs selenium-hub

    - name: Check Selenium Chrome Node logs
      run: docker logs selenium-chrome

    - name: Run .NET tests
      run: dotnet test SampleDotNetApp.Tests --logger:"trx;LogFileName=TestResults.trx" -v d

    - name: Upload test logs
      uses: actions/upload-artifact@v2
      with:
        name: test-log
        path: SampleDotNetApp.Tests/TestResults/test-log.txt

    - name: Clean up
      run: |
        docker stop selenium-hub selenium-chrome
        docker rm selenium-hub selenium-chrome
        docker network rm selenium-grid
